<?xml version="1.0"?>
<ETL xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" VERSION="1.0" xsi:noNamespaceSchemaLocation="F:\Development\XML\ketl.xsd">
<!--  Example: Parse file, split by record type, parse as XML and output
	        Steps: 1. Read file line by line
	               2. Use regular expression matcher to filter records
	               3. Use XML to fields to convert string to xml and extract fields
	               4. Output data to console, db, file etc..
     -->
	<PARAMETER_LIST NAME="myleoPageTrackingLogFiles">
		<PARAMETER NAME="SEARCHPATH">c:\temp\page\*</PARAMETER>
	</PARAMETER_LIST>
	<PARAMETER_LIST NAME="DestinationDB">
		<PARAMETER NAME="USER">TEST</PARAMETER>
		<PARAMETER NAME="PASSWORD">TEST</PARAMETER>
		<PARAMETER NAME="URL">jdbc:oracle:thin:@localhost:1521:orcl</PARAMETER>
		<PARAMETER NAME="DRIVER">oracle.jdbc.driver.OracleDriver</PARAMETER>
	</PARAMETER_LIST>
	<JOB ID="leoPageTracking" NAME="leoPageTracking" BATCHSIZE="5000" PARRALLISM="2" PROJECT="TEST" TYPE="KETL">
		<DEPENDS_ON>RSYNC</DEPENDS_ON>
		<ACTION>
<!-- READ PHASE -->
<!--  Read file record by record -->
			<STEP NAME="XMLFilePageTracking" CLASS="com.kni.etl.ketl.reader.NIOFileReader" CHARACTERSET="UTF-8" PARAMETER_LIST="myleoPageTrackingLogFiles">
				<OUT NAME="XML" DATATYPE="STRING"/>
			</STEP>
<!--  Parse field as XML documents and extract fields -->
			<STEP ERRORLIMIT="10" NAME="ExtractPageTrackingData" THREADS="4" XPATHEVALUATE="FALSE" XPATH="track" CLASS="com.kni.etl.ketl.transformation.XMLToFieldsTransformation" PARAMETER_LIST="myDestinationDB">
				<IN XMLDATA="TRUE"> XMLFilePageTracking.XML</IN>
				<OUT NAME="SESSION_ID" DATATYPE="INTEGER" XPATHEVALUATE="FALSE" XPATH="@session_id"/>
				<OUT NAME="MEMBER_ID" DATATYPE="INTEGER" XPATHEVALUATE="FALSE" XPATH="@member_id"/>
				<OUT NAME="PAGE_SEQ" DATATYPE="INTEGER" XPATHEVALUATE="FALSE" XPATH="pageSeq"/>
				<OUT NAME="PAGE_KEY_IN" DATATYPE="STRING" XPATHEVALUATE="FALSE" XPATH="pageKey"/>
				<OUT NAME="TRACKING_TIME" DATATYPE="DATE" FORMATSTRING="e" XPATHEVALUATE="FALSE" XPATH="@tracking_time"/>
				<OUT NAME="TRACKING_INFO_IN" DATATYPE="STRING" XPATHEVALUATE="FALSE" XPATH="trackingInfo"/>
				<OUT NAME="BL_TIME" DATATYPE="INTEGER" XPATHEVALUATE="FALSE" XPATH="blTime"/>
				<OUT NAME="TOTAL_TIME" DATATYPE="INTEGER" XPATHEVALUATE="FALSE" XPATH="totalTime"/>
				<OUT NAME="TRACKING_CODE_IN" DATATYPE="STRING" XPATHEVALUATE="FALSE" XPATH="trackingCode"/>
				<OUT NAME="ERROR_ID_IN" DATATYPE="STRING" XPATHEVALUATE="FALSE" XPATH="errorMsgKey"/>
			</STEP>
			<STEP NAME="TransformPageTracking" CLASS="com.kni.etl.ketl.transformation.DynamicTransformation">
				<IN>ExtractPageTrackingData.*</IN>
				<OUT>${SESSION_ID}</OUT>
				<OUT>${MEMBER_ID}</OUT>
				<OUT>${PAGE_SEQ}</OUT>
				<OUT NAME="PAGE_KEY" DATATYPE="STRING">${PAGE_KEY_IN}!=null &amp;&amp;${PAGE_KEY_IN}.length()&gt;100?${PAGE_KEY_IN}.substring(0,100):${PAGE_KEY_IN}</OUT>
				<OUT>${TRACKING_TIME}</OUT>
				<OUT NAME="TRACKING_INFO" DATATYPE="STRING">${TRACKING_INFO_IN}!=null &amp;&amp;${TRACKING_INFO_IN}.length()&gt;50?${TRACKING_INFO_IN}.substring(0,50):${TRACKING_INFO_IN}</OUT>
<!-- 				<OUT>${NUM_RESULTS}</OUT>-->
				<OUT>${BL_TIME}</OUT>
				<OUT>${TOTAL_TIME}</OUT>
				<OUT NAME="TRACKING_CODE" DATATYPE="STRING">${TRACKING_CODE_IN}!=null &amp;&amp;${TRACKING_CODE_IN}.length()&gt;20?${TRACKING_CODE_IN}.substring(0,20):${TRACKING_CODE_IN}</OUT>
				<OUT NAME="ERROR_KEY" DATATYPE="STRING">${ERROR_ID_IN}!=null &amp;&amp; ${ERROR_ID_IN}.length()&gt;200?${ERROR_ID_IN}.substring(0,200):${ERROR_ID_IN}</OUT>
			</STEP>
<!--			<STEP NAME="PageTrackingErrorIdKeyGenerator" CLASS="com.kni.etl.ketl.transformation.JDBCIncrementer" PARAMETER_LIST="DestinationDB" TABLE="ERROR_KEYS">
				<IN>"ERROR_ID"</IN>
				<OUT NAME="ERROR_ID"/>
			</STEP>
			<STEP NAME="UpsertPageTrackingErrorId" CLASS="com.kni.etl.ketl.writer.JDBCWriter" PARAMETER_LIST="DestinationDB" TABLE="ERROR_KEYS">
				<IN NAME="ERROR_ID" PK="TRUE">PageTrackingErrorIdKeyGenerator.ERROR_ID</IN>
				<IN NAME="ERROR_KEY" SK="TRUE">TransformPageTracking.ERROR_KEY</IN>
				<TRIGGER NAME="INCREMENT_PK" EVENT="INSERT" STEP="KeyGenerator" HANDLER="INCREMENT"/>
			</STEP>
			<STEP NAME="PageTrackingErrorIdLookup" CLASS="com.kni.etl.ketl.transformation.LookupTransformation" PARAMETER_LIST="DestinationDB" TABLE="WEB_AGENT">
				<IN>TransformPageTracking.*</IN>
				<OUT>${SESSION_ID}</OUT>
				<OUT>${MEMBER_ID}</OUT>
				<OUT>${PAGE_SEQ}</OUT>
				<OUT>${PAGE_KEY}</OUT>
				<OUT>${TRACKING_TIME}</OUT>
				<OUT>${TRACKING_INFO}</OUT>
				<OUT>${BL_TIME}</OUT>
				<OUT>${TOTAL_TIME}</OUT>
				<OUT>${TRACKING_CODE}</OUT>
				<IN NAME="ERROR_KEY">TransformPageTracking.ERROR_KEY</IN>
				<OUT NAME="ERROR_ID"/>
			</STEP> -->
<!-- Write the record into the DB using JDBC -->
			<STEP NAME="Target" CLASS="com.kni.etl.ketl.writer.JDBCWriter" PARAMETER_LIST="DestinationDB" TABLE="PAGE_TRACKING_TMP" ERRORLIMIT="2000">
				<PRESQL>truncate table PAGE_TRACKING</PRESQL>
				<PRESQL>truncate table PAGE_TRACKING_TMP</PRESQL>
				<IN>TransformPageTracking.*</IN>
				<xPOSTSQL>INSERT INTO PAGE_TRACKING SELECT SESSION_ID, MEMBER_ID, PAGE_SEQ, PAGE_KEY, TRACKING_TIME, TRACKING_INFO, BL_TIME, TOTAL_TIME, TRACKING_CODE, ERROR_ID FROM PAGE_TRACKING_TMP T, ERROR_KEYS K WHERE T.ERROR_KEY=K.ERROR_KEY(+)</xPOSTSQL>
			</STEP>
		</ACTION>
	</JOB>
</ETL>
